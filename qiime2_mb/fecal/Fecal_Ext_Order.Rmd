---
title: "R Notebook"
output: word_document
editor_options: 
  chunk_output_type: console
---

#Load required libraries
```{r}
library("biom")
library(data.table)
```

#Taxonomy Reference - Control Annotations
Read in controls taxonomy file, grouped by order
```{r}
order_percent <- read.table("T:\\DCEG\\CGF\\TechTransfer\\Microbiome\\Extraction\\Optimization\\Fresh Fecal Optimization_2017.08\\Controls\\Taxonomy\\Taxonomy_order.txt",sep="\t",header=TRUE)

#Add row names to order full
order_list <- unique(order_percent[,"Order"])
rownames(order_percent) <- order_list

#Create Control Composition Database, removing rows of species not in samples, followed by samples not of specified control type
##Artifical Colony
art.col.con <- subset(order_percent, !(Art.Col=='NA'))
art.col.con <- art.col.con[,1:10]

##Two concentrations of zymo extraction controls
zymo.seq200.con <- subset(order_percent, !(Zymo.Seq=='NA'))
zymo.seq200.con <- zymo.seq200.con[,c(1:9,15)]
zymo.seq2000.con <- zymo.seq200.con

#Zymo Sequencing Control
zymo.ext.con <-subset(order_percent, !(Zymo.Ext=='NA'))
zymo.ext.con <- zymo.ext.con[,c(1:9,16)]

#ATTC Controls
msa1000.con <-subset(order_percent, !(MSA1000=='NA'))
msa1000.con <- msa1000.con[,c(1:9,11)]

msa1001.con <- subset(order_percent, !(MSA1001=='NA'))
msa1001.con <- msa1001.con[,c(1:9,12)]

msa1002.con <- subset(order_percent, !(MSA1002=='NA'))
msa1002.con <- msa1002.con[,c(1:9,13)]

msa1003.con <- subset(order_percent, !(MSA1003=='NA'))
msa1003.con <- msa1003.con[,c(1:9,14)]

```

#Variable info
Read in the entire control variable database, and controls that failed threshold QC. 
Filter database removing all failed sampels, and any that are not a control
```{r}
#Read in database with variable information and list of samples that did not meet the sequencing threshold
variable_info <- read.table("T:\\DCEG\\CGF\\TechTransfer\\Microbiome\\Extraction\\Optimization\\Fresh Fecal Optimization_2017.08\\Analysis\\Run1&2\\Manifests\\sampledata.txt",sep="\t",header=TRUE)
samples_failed <- read.table("T:\\DCEG\\CGF\\TechTransfer\\Microbiome\\Extraction\\Optimization\\Fresh Fecal Optimization_2017.08\\Analysis\\Run1&2\\Manifests\\samples_being_ignored.txt",sep="\t")

#Remove failed samples from info database
filtered_info <-subset(variable_info, !(NephID %in% samples_failed$V1))

#Verify filtering - numbers should match
nrow(variable_info) - nrow(samples_failed)
nrow(filtered_info)

#Remove Study samples from database
control_info <- subset(filtered_info,!Type=='Study')
control_info <- subset(control_info,!Type=='EB')
control_info <- subset(control_info,!Type=='RG')

#Verify the subsetting - numbers should match
nrow(filtered_info) - sum(filtered_info$Type=='Study') - sum(filtered_info$Type=='EB') - sum(filtered_info$Type=='RG')
nrow(control_info)

#Add Row names to dataframe
row.names(control_info) <- control_info$NephID
```

#OTU Counts - OTU's by order (raw data)
Read in OTU information, and determine total order counts
```{r}
#Read in OTU database at order level
order_otu <- read.csv("T:\\DCEG\\CGF\\TechTransfer\\Microbiome\\Extraction\\Optimization\\Fresh Fecal Optimization_2017.08\\Analysis\\Run1&2\\TaxaCounts\\taxa_counts_order.csv", row.names = 1)

#Create a total row for each sample
sample_list <- colnames(order_otu)
order_list <- rownames(order_otu)

#For each sample
for (a in sample_list){
 #Set sum to 0
 sum=0
 
 #For each order
 for (b in order_list){
  #Add the number of counts together
  sum <- order_otu[b,a] + sum
 }
 
 #When complete, push to a "Total_Reads" row
 order_otu["Total_Reads",a] <- sum
 
 
}
```

#OTU Counts - Analysis order Expected in Controls by Control Type
Read in OTU information, and determine order counts (presence/absence) for each sample
```{r}
#Create control sample list, control type list
sample_list <- unique(control_info$NephID)
control_types <- unique(control_info$Type)

#Create a missing list for non-annotated order
missing_anno <- list()

#Determine which order_list to use
##Run through each sample
for (a in sample_list){
 
 #Set count to 0
 count_present = 0
 count_absent = 0
 
 #Create order list of control types
 if(control_info[a,"Type"]=="AC"){
  order_list <- unique(art.col.con$Order)
  } else if(control_info[a,"Type"]=="Zymo.Ext"){
   order_list <- unique(zymo.ext.con$Order)
  } else if(control_info[a,"Type"]=="MSA-1000"){
    order_list <- unique(msa1000.con$Order)
  } else if(control_info[a,"Type"]=="MSA-1001"){
   order_list <- unique(msa1001.con$Order)
   } else if(control_info[a,"Type"]=="MSA-1002"){
    order_list <- unique(msa1002.con$Order)
    } else if(control_info[a,"Type"]=="MSA-1003"){
     order_list <- unique(msa1003.con$Order)
     } else if(control_info[a,"Type"]=="Zymo.Seq.200"){
      order_list <- unique(zymo.seq200.con$Order)
      } else if(control_info[a,"Type"]=="Zymo.Seq.2000"){
       order_list <- unique(zymo.seq2000.con$Order)
       } else {order_list <- data.frame()}
 
 #Convert to character
 order_list <- as.character(order_list)
 
 #For each order is list, determine number of reads
 for (b in order_list){
  value <- order_otu[b,a]

  #If value is NA (meaning that the order was not found in sample), skip
  #If reads are >0 then count_presence increases by 1
  #If reads are =0 then count_absence increases by 1 

  if(is.na(value) | is.null(value)) {
   missing_anno[[b]] <- "No Annotations"
   next
  } else if (value>0) {
   count_present = count_present +1
  } else if (value==0){
   count_absent = count_absent +1
  } else{
   next
   }
 }
 
 #Add final count and length of the list to Control_Info dataframe
 control_info[a,"orderCount"] <- count_present
 control_info[a,"orderAbsent"] <- count_absent
 control_info[a,"orderExpect"] <- length(order_list)
}

#New Database to store final order information
order_otucount_controls <- data.frame()

#For each of the control types
for (b in control_types){
 
 #Reset counts
 order=0
 total=0
 count=0
 
 #For each of the samples in the sample list
 for(a in sample_list){
  
  #Create control type groups
  valid <- control_info[a,"Type"]
  
  #If the current samples control type matches the control type of the iteration
  if(valid==b){
   
   #Add the total number of order found
   #Add the total number of order expected, and subtract the number missing (this is necessary as some
   #order are not found in the list, and not necessarily absent from the sample)
   order <- order + control_info[a,"orderCount"]
   total <- total + control_info[a,"orderCount"] + control_info[a,"orderAbsent"]
   expect <- control_info[a,"orderExpect"]
   count <- count + 1
  } else{
    next
   }
 }
 
 #Find the average of the order and totals
 order_average <- order/count
 total_average <- total/count
 
 #Push the totals to the new database 
 order_otucount_controls[1,b] <- order_average
 order_otucount_controls[2,b] <- total_average
 order_otucount_controls[3,b] <- expect

 #Add Row names
 row.names(order_otucount_controls) <- c("order Count","Total", "Expected")
}
```

#OTU Counts - Analysis order OTU Presence/Absence by Control Type by Kit (Ext Control Only)
Extraction controls by control type by kit
```{r}
#Unique Kits, removing "None" as a kit type
kit_types <- unique(control_info$Kit)
kit_types <- kit_types[!kit_types %in% "None"]

#Control Types for Extraction only - no information for Sequencing controls
control_types <- c("AC", "Zymo.Ext")

#New Database for order level count information from kits
order_otucount_ext_kit <- data.frame()

#Reset counters
sums =0
row_count =0
row_count2 =0

#For each of the extraction kits
for (a in kit_types){
 
 #Group by control types
 for (b in control_types) {
  
  #Reset counters
  order =0
  total=0
  expect=0

  #Create a list of samples that are of the specified kit and control type
  sample_list<- subset(control_info, Kit==a & Type==b)
  sample_list <- unique(sample_list$NephID)

  #For each sample in the list
  for (c in sample_list){
   
   #Count the number of unique order found
   #Count the total number of gensus matched in reference database
   #Count the number of expected order for this sample
   order <- order + control_info[c,"orderCount"]
   total <- total + control_info[c,"orderCount"] + control_info[c,"orderAbsent"]
   expect <- control_info[c,"orderExpect"]
  }
  
  #Take the average of all extracted iterations of this control  with this kit of
  order_average <- order/length(sample_list)
  total_average <- total/length(sample_list)
  
  #Move the row counters by 1 or 2
  row_count <- sums +1
  row_count2 <- sums+2
  
  #Push information to the database
  order_otucount_ext_kit[row_count, b] <- order_average
  order_otucount_ext_kit[row_count2, b] <- order_average
 }
 
 #Increase the row counter to skip the two filled rows
 sums = sums+2
}

#Add row names to the database
row.names (order_otucount_ext_kit) <- c("Qiagen DSPs_Count", "Qiagen DSP_Expected", "Zymo Mag Bead_Count", "Zymo MagBead_Expected", "PowerMag Soil_Count", "PowerMag Soil_Expected", "PowerMag MB_Count", "PowerMag MB_Expected", "Qiagen QIAmp_Count", "Qiagen QIAmp_Expected")  
```

#OTU Percent - Analysis order OTU Abundance (All Samples)
```{r}
#Create sample list
sample_list <- unique(control_info$NephID)
order_list <- rownames(order_otu[1:nrow(order_otu)-1,])

#Create new table
order_otuabund_sample = data.frame()

#Determine which order_list to use
##Run through each sample
for (a in sample_list){
 
 for (b in order_list){
  
  #Determine the reads for the order, and the total reads for the sample
  reads <- order_otu[b,a]
  total <- order_otu["Total_Reads",a]

  #If value is NA (meaning that the order was not found in sample), skip
  #If reads are >0 then add the read count to reads_total

  if(is.na(reads) | is.null(reads)) {
   next
  } else {
   percent <- (reads/total)
   
   #Add out count percent to the order_otuabund_sample database
   order_otuabund_sample[b,a] <- percent
  }
 }
}

#Output the table of all samples
write.csv(order_otuabund_sample,"Data/order_otuabund_sample.csv")
```

#OTU Percent - Analysis order OTU Abundance by Control Type
```{r}
#Unique Types of controls and all order
control_types <- unique(control_info$Type)
order_list <- rownames(order_otu[1:nrow(order_otu)-1,])

#New Database to store final order information
order_otuabund_control <- data.frame()

#For each of the control types
for (a in control_types){
 
  #For each order in list
  for (b in order_list){
   
   #Reset Counter
   reads <- 0
   total <- 0
   
   #Create a list of samples that are of the specified control type
   sample_list<- subset(control_info, Type==a)
   sample_list <- unique(sample_list$NephID)
   
   #For each of the samples in the sample list
   for(c in sample_list){
    
    #Add up the total percentages from otupercent_sample table [order,sampleID]
    reads <- order_otu [b,c] + reads
    total <- order_otu["Total_Reads",c] + total
   }
   
   #average of order level by taking total number of reads of that order divded by 
   #total number of reads for samples included
   #Push value to new dataframe
   percent <- reads / total
   order_otuabund_control[b,a] <- percent
  }
 }

#Output to text file
write.csv(order_otuabund_control,"Data/order_otuabund_control.csv")
```

#OTU Percent - Analysis order OTU Abundance by Control Type by Kit (Ext Control Only)
```{r}
#Unique Types of controls and all order
kit_types <- unique(control_info$Kit)
kit_types <- kit_types[-6] #Removing the None group
order_list <- rownames(order_otu[1:nrow(order_otu)-1,])

#Store column number
cols <- ncol(order_percent)

#For each of the kits types
for (a in kit_types){
 
  #For each order in list
  for (b in order_list){
   
   #Reset Counter
   reads <- 0
   total <- 0
   
   #Create a list of samples that are of the specified control type
   sample_list<- subset(control_info, Kit==a)
   sample_list <- unique(sample_list$NephID)
   
   #For each of the samples in the sample list
   for(c in sample_list){
    
    #Add up the total percentages from otupercent_sample table [order,sampleID]
    reads <- order_otu [b,c] + reads
    total <- order_otu["Total_Reads",c] + total
   }
   
   #average of order level by taking total number of reads of that order divded by 
   #total number of reads for samples included
   #Push value to new dataframe
   percent <- reads / total
   order_percent[b,a] <- percent
  }
}
#Repeat at the control by kit level
control_types<-c("AC","Zymo.Ext")

i = ncol(order_percent) +1
#For each of the kits types
for (a in kit_types){
 for(b in control_types){
  #Create a list of samples that are of the specified control type
  sample_list<- subset(control_info, Kit==a & Type==b)
  sample_list <- unique(sample_list$NephID)
  
  for(c in order_list){
   
   #Reset Counter
   reads <- 0
   total <- 0

    #For each of the samples in the sample list
   for(d in sample_list){
    
    #Add up the total percentages from otupercent_sample table [order,sampleID]
    reads <- order_otu [c,d] + reads
    total <- order_otu["Total_Reads",d] + total
   }
   
   #average of order level by taking total number of reads of that order divded by 
   #total number of reads for samples included
   #Push value to new dataframe
   percent <- reads / total
   order_percent[c,i] <- percent
  }
  i=i+1
 }
}

i=cols+1
#Add column names
new_colnames<- c("Qiagen DSP Virus_OB", "Zymo MagBead DNone Kit_OB","MagAttract PowerMag Soil_OB",
                 "MagAttract PowerMag Microbiome_OB","Qiagen QIAamp  Modified_OB",
                 "Qiagen DSP Virus_OB_AC", "Qiagen DSP Virus_OB_ZE",
                 "Zymo MagBead DNone Kit_OB_AC","Zymo MagBead DNone Kit_OB_ZE",
                 "MagAttract PowerMag Soil_OB_AC","MagAttract PowerMag Soil_OB_ZE",
                 "MagAttract PowerMag Microbiome_OB_AC","MagAttract PowerMag Microbiome_OB_ZE",
                 "Qiagen QIAamp  Modified_OB_AC","Qiagen QIAamp  Modified_OB_ZE")

#for each header name, apply it to the recently created columns
for (a in new_colnames){
 colnames(order_percent)[i]<- a
 i=i+1
}

#Output to text file
write.csv(order_percent,"Data/order_outabund_kit.csv")
```

#OTU Percent - Analysis of order Percent Abundance Differences, expected versus observed by kit (Ext Only)
Perform AC and Zymo.Ext Comparisons
```{r}
#Create new order databse with only AC and Zymo Columns
#Remove order groups not included in control types
temp <- data.frame()
temp <- order_percent[,c(11,16,23:32)]
temp <- subset(temp, !(Art.Col=="NA" & Zymo.Ext=="NA"))

#Save the column start
cols=ncol(order_percent)

#Set the counter
i=cols+1

#Create lists to compare kits
order_list <- unique(rownames(temp))
compare_list <- unique(colnames(temp[,3:12]))

#For each kit 
for (a in compare_list){
 #For each order, within the artifical colony list
 for (b in order_list){
  #Determine abundance value
  if(i%%2==0){
   value <- temp[b,"Zymo.Ext"]
  }
  else{value <- temp[b,"Art.Col"]
  }
  
  #If the value is NA fill in NA
  if(is.na(value)){
   order_percent[b,i] <- "NA"
  }
  #Otherwise, fill in the abundance rate
  else{
   order_percent[b,i] <- ((value - temp[b,a])/value)*100*-1
  }
  
 }
 
 #increase the counter
 i=i+1
}

#Add column names
new_colnames <- c("Qiagen DSP-AC_Diff","Qiagen DSP-ZE_Diff",
                  "Zymo MagBead-AC_Diff","Zymo MagBead-ZE_Diff", "MagAttract PS-AC_Diff",
                  "MagAttract PS-ZE_Diff", "MagAttract MB-AC_Diff","MagAttract MB-ZE_Diff", 
                  "Qiagen QIAmp-AC_Diff", "Qiagen QIAMmp-ZE_Diff")

i=cols+1
for (a in new_colnames){
 colnames(order_percent)[i]<- a
 i=i+1
}

#subset table to include only relevant order, and only control information for extraction
temp <- order_percent[,c(11,16,18:42)]
temp <- subset(temp, !(Art.Col=="NA" & Zymo.Ext=="NA"))

#Output file
write.csv(temp,"Data/order_otuabund_obsVSexp_ext.csv")
```

#OTU Percent - Not expected order by Control Type by Kit (Ext Control Only)
```{r}

#Create temp dataframe from order_percent
temp <- order_percent[,c(11,16,23:32)]

#Subset by those order not expected to be in extraction
temp <- subset(temp, is.na(Art.Col) | is.na(Zymo.Ext))

#Output the unexpected percent frequency database
write.csv(temp,"Data/order_other.csv")
```
